{% extends "base.html" %}
{% from "components/score_meter.html" import score_meter %}
{% block title %}ThreatKit â€” URL Checker{% endblock %}

{% block content %}
<h1 class="h4">URL Scanner</h1>
<p class="tk-subtle">Enter a URL to check for potential phishing indicators.</p>

<--! URL Input Form -->
<form method="POST" class="tk-card" autocomplete="off">
  <label for="lk" class="form-label">Enter a link to evaluate</label>
  <div class="input-group mb-3">
    <input
      id="lk"
      name="url"
      type="url"
      class="form-control tk-input"
      placeholder="https://example.com"
      required
      maxlength="500"
      aria-describedby="lkHelp"
      value="{{ prefill or '' }}"
    />
    <button class="btn btn-accent" type="submit">Scan</button>
  </div>

  <div id="lkHelp" class="form-text tk-subtle">
    We do not store input, processing occurs in memory only.
  </div>

  {% if report %}
  <hr class="tk-sep my-3" />

  <div class="row g-4">
    <div class="col-md-6">
      <div class="tk-card mb-4">
        {{ score_meter(report.score, 5, report.label) }}
      </div>

      <div class="tk-card">
        <div class="fw-semibold mb-2">Checks & Reasons</div>
        <ul class="list-group mb-0">
          {% for check in report.results %}
            <li class="list-group-item"
                style="background:transparent;border-color:var(--border);color:var(--text);">
              <div class="d-flex justify-content-between align-items-center">
                <strong>{{ check.name }}</strong>
                {% if check.triggered %}
                  <span class="tk-chip text-danger">Issue</span>
                {% else %}
                  <span class="tk-chip text-success">OK</span>
                {% endif %}
              </div>

              {% if check.triggered %}
                <div class="small tk-subtle mt-1">{{ check.reason }}</div>
              {% else %}
                <div class="small tk-subtle mt-1">No issues detected.</div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="col-md-6">
      <div class="tk-card">
        <div class="fw-semibold mb-2">AI Analysis Summary</div>
        <div id="ai-summary" class="tk-subtle" style="white-space: pre-wrap;">
          <em>Loading AI analysis...</em>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const summaryBox = document.getElementById("ai-summary");

    fetch("{{ url_for('url_scanner.ai_summary') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url: "{{ report.url }}" })
    })
    .then(res => res.json())
    .then(data => {
        summaryBox.textContent = data.summary || "No response.";
    })
    .catch(err => {
        summaryBox.textContent = "Error loading AI analysis.";
    });
  });
  </script>

  {% endif %}
</form>
{% endblock %}