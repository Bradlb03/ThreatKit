{% extends "base.html" %}
{% block title %}ThreatKit — Malware Checker{% endblock %}
{% from "components/score_meter.html" import score_meter %}

{% block content %}
<div class="container my-5">

  <h1 class="h4 mb-2">Malware Checker</h1>
  <p class="text-secondary mb-4">
    Upload a file to scan with our static ML model and YARA rules. Never upload sensitive files.
  </p>

  <!-- Upload Form -->
  <form action="{{ url_for('malware.scan_file') }}" method="post"
        enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input class="form-control" type="file" name="file" required>
      <button class="btn btn-accent" type="submit">Upload</button>
    </div>
  </form>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning mt-2 mb-0 small">
        {% for message in messages %}
          {{ message }}<br>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if result %}
  <div class="row g-4 mt-2">

    <!-- Score + ML/YARA numbers -->
    <div class="col-md-6">
      <div class="tk-card mb-4">
        {{ score_meter(result.score_5|int, 5, result.score_label ~ " — " ~ result.prediction) }}

        <div class="mt-3 tk-subtle small">
          Combined risk: {{ result.combined }} ·
          ML probability: {{ result.ml }} ·
          YARA score: {{ result.yara }}
        </div>
      </div>

      <!-- YARA Rules -->
      <div class="tk-card">
        <div class="fw-semibold mb-2">YARA Signatures</div>

        {% if result.rules and result.rules|length > 0 %}
          <div class="d-flex flex-wrap gap-2">
            {% for rule in result.rules %}
              <span class="tk-chip">{{ rule.replace('_', ' ') }}</span>
            {% endfor %}
          </div>
        {% else %}
          <div class="tk-subtle">No YARA signatures were triggered.</div>
        {% endif %}

        <div class="tk-sep my-3"></div>
        <div class="small tk-subtle">
          Scores 1–2 usually indicate high suspicion; 4–5 indicate likely benign files.
        </div>
      </div>
    </div>

    <!-- AI Summary Panel -->
    <div class="col-md-6">
      <div class="tk-card">
        <div class="fw-semibold mb-2">AI Analysis Summary</div>
        <div id="ai-summary" class="tk-subtle" style="white-space: pre-wrap;">
          <em>Loading AI analysis...</em>
        </div>
      </div>
    </div>

  </div>

  <!-- JS: Fetch AI Summary -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const summaryBox = document.getElementById("ai-summary");
      if (!summaryBox) return;

      fetch("{{ url_for('malware.ai_summary') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          result: {{ result|tojson|safe }}
        })
      })
      .then(res => res.json())
      .then(data => {
        summaryBox.textContent = data.summary || "No AI response.";
      })
      .catch(err => {
        summaryBox.textContent = "Error loading AI analysis.";
      });
    });
  </script>

  {% endif %}
</div>
{% endblock %}

