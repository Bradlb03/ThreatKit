{% extends "base.html" %}
{% block title %}ThreatKit — Malware Checker{% endblock %}
{% from "components/score_meter.html" import score_meter %}

{% block content %}
<div class="container my-5">

  <h1 class="h4 mb-2">Malware Checker</h1>
  <p class="text-secondary mb-4">
    Upload a file to scan with our static ML model and YARA rules. Never upload sensitive files.
  </p>

  <!-- Upload Form -->
  <form id="malware-form" action="{{ url_for('malware.scan_file') }}" method="post"
      enctype="multipart/form-data" class="tk-card mb-3">

<input id="file-input" type="file" name="file" class="d-none" required>
  <div id="dropzone" class="tk-dropzone d-flex flex-column align-items-center justify-content-center text-center p-4"
       role="button" tabindex="0" aria-label="Upload file">
    <div class="mb-2 fw-semibold">Drag & drop a file here</div>
    <div class="tk-subtle small">…or click to choose</div>
    <div id="dz-filename" class="mt-2 small tk-subtle"></div>
    <button type="button" id="choose-btn" class="btn btn-accent mt-3">Choose File</button>
  </div>

  <div class="d-flex justify-content-end gap-2 pt-3">
    <button type="submit" class="btn btn-accent">Scan</button>
  </div>
</form>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-warning mt-2 mb-0 small">
        {% for message in messages %}
          {{ message }}<br>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if result %}
  <div class="row g-4 mt-2">

    <!-- Score + ML/YARA numbers -->
    <div class="col-md-6">
      <div class="tk-card mb-4">
        {{ score_meter(result.score_5|int, 5, result.score_label ~ " — " ~ result.prediction) }}

        <div class="mt-3 tk-subtle small">
          Combined risk: {{ result.combined }} ·
          ML probability: {{ result.ml }} ·
          YARA score: {{ result.yara }}
        </div>
      </div>

      <!-- YARA Rules -->
      <div class="tk-card">
        <div class="fw-semibold mb-2">YARA Signatures</div>

        {% if result.rules and result.rules|length > 0 %}
          <div class="d-flex flex-wrap gap-2">
            {% for rule in result.rules %}
              <span class="tk-chip">{{ rule.replace('_', ' ') }}</span>
            {% endfor %}
          </div>
        {% else %}
          <div class="tk-subtle">No YARA signatures were triggered.</div>
        {% endif %}

        <div class="tk-sep my-3"></div>
        <div class="small tk-subtle">
          Scores 1–2 usually indicate high suspicion; 4–5 indicate likely benign files.
        </div>
      </div>
    </div>

    <!-- AI Summary Panel -->
    <div class="col-md-6">
      <div class="tk-card">
        <div class="fw-semibold mb-2">AI Analysis Summary</div>
        <div id="ai-summary" class="tk-subtle" style="white-space: pre-wrap;">
          <em>Loading AI analysis...</em>
        </div>
      </div>
    </div>

  </div>

  <!-- JS: Fetch AI Summary -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const summaryBox = document.getElementById("ai-summary");
      if (!summaryBox) return;

      fetch("{{ url_for('malware.ai_summary') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          result: {{ result|tojson|safe }}
        })
      })
      .then(res => res.json())
      .then(data => {
        summaryBox.textContent = data.summary || "No AI response.";
      })
      .catch(err => {
        summaryBox.textContent = "Error loading AI analysis.";
      });
    });
  </script>

  {% endif %}
<script>
  (function () {
    const form = document.getElementById('malware-form');
    const input = document.getElementById('file-input');
    const dz = document.getElementById('dropzone');
    const btn = document.getElementById('choose-btn');
    const nameEl = document.getElementById('dz-filename');
    if (!form || !input || !dz) return;

    dz.addEventListener('click', (e) => {
      if (e.target.closest('#choose-btn')) return; 
      input.click();
    });

    if (btn) {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        input.click();
      });
    }

    dz.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        if (document.activeElement === btn) return;
        e.preventDefault();
        e.stopPropagation();
        input.click();
      }
    });

    input.addEventListener('change', () => {
      nameEl.textContent = input.files?.[0]?.name ? `Selected: ${input.files[0].name}` : '';
    });

    ['dragenter','dragover'].forEach(ev =>
      dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.add('is-dragover'); })
    );
    ['dragleave','dragend','drop'].forEach(ev =>
      dz.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('is-dragover'); })
    );

    dz.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (!files || !files.length) return;
      input.files = files;
      nameEl.textContent = `Selected: ${files[0].name}`;
    });
  })();
</script>


</div>
{% endblock %}

