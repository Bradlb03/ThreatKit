<!-- email.html-->
{% extends "base.html" %}
{% from "components/score_meter.html" import score_meter %}
{% block title %}ThreatKit — Phishing Email Checker{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Phishing Email Checker</h1>
<p class="text-secondary mb-4">
  Higher score = safer. 5 = very safe, 0 = phishing.
</p>

<form method="POST" enctype="multipart/form-data" class="tk-card vstack gap-3">
  <!-- EML Upload (optional) -->
<div>
  <label class="form-label">Upload .eml File (optional)</label>
  <div class="tk-dropzone">
    <input type="file" name="eml_file" class="form-control tk-input" accept=".eml" />
    <small class="tk-subtle">Drag & drop a .eml file or click to choose.</small>
  </div>
</div>

  <div>
    <label class="form-label">Sender (From)</label>
    <!-- no required here so .eml upload works without a manual sender -->
    <input name="from" class="form-control tk-input" />
  </div>

  <div>
    <label class="form-label">Return-Path (optional)</label>
    <input name="return_path" class="form-control tk-input" />
  </div>

  <div>
    <label class="form-label">Subject</label>
    <input name="subject" class="form-control tk-input" />
  </div>

  <div>
    <label class="form-label">Body</label>
    <textarea name="body" class="form-control tk-input" rows="10"></textarea>
  </div>

  <div class="d-flex gap-2">
    <button type="submit" class="btn btn-accent">Analyze</button>
    <a href="{{ url_for('emailcheck.phishing_page') }}" class="btn btn-outline-secondary">Clear</a>
  </div>

  {% if result %}
    {% if result.error %}
      <hr class="my-4" />
      <div class="alert alert-danger mb-0">{{ result.error }}</div>
    {% else %}
      <hr class="my-4" />

      <div id="email-results" class="row g-4">
        <!-- Left: unified circular meter -->
        <div class="col-md-6">
          <div class="tk-card">
            {{ score_meter(result.safety_score|float|round(0, 'common')|int, 5, result.category) }}
            <div class="mt-3 tk-subtle">
              Safety score (0–5). Higher = safer.
              {% if result.safety_score is defined %}
                Raw: {{ result.safety_score|round(1) }} / 5
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Right: indicators + ML details -->
        <div class="col-md-6">
          <div class="tk-card">
            <div class="fw-semibold mb-2">Indicators</div>
            {% if result.key_indicators and result.key_indicators|length > 0 %}
              <div class="d-flex flex-wrap gap-2">
                {% for ex in result.key_indicators %}
                  <span class="tk-chip">{{ ex }}</span>
                {% endfor %}
              </div>
            {% else %}
              <div class="tk-subtle">No strong indicators found.</div>
            {% endif %}

            <div class="tk-sep my-3"></div>

            {% if result.ml %}
              {% if result.ml.error %}
                <div class="small text-warning">Model error — rules only: {{ result.ml.error }}</div>
              {% else %}
                <div class="small tk-subtle">
                  Model:
                  {% if result.ml.prediction %} {{ result.ml.prediction }} {% endif %}
                  {% if result.ml.confidence is not none %} ({{ (result.ml.confidence * 100)|round(1) }}%) {% endif %}
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>

      <!-- raw context card -->
      <div class="tk-card mt-4">
        <div class="fw-semibold mb-2">Context</div>
        <ul class="tk-subtle mb-0 small">
          <li><strong>Sender domain:</strong> {{ result.raw.sender_domain or '—' }}</li>
          <li><strong>Return-Path domain:</strong> {{ result.raw.return_path_domain or '—' }}</li>
          <li><strong>Parsed links:</strong>
            {% if result.raw.parsed_links and result.raw.parsed_links|length %}
              <ul class="mb-0">
                {% for link in result.raw.parsed_links[:3] %}
                  <li>{{ link }}</li>
                {% endfor %}
              </ul>
            {% else %}
              none detected
            {% endif %}
          </li>
          {% if result.raw.parsed_links and result.raw.parsed_links|length %}
          <div class="mt-3">
            <a
              class="btn btn-accent"
              href="{{ url_for('url_scanner.page') }}?url={{ result.raw.parsed_links[0] | urlencode }}"
            >
              Check Link
            </a>
          </div>
          {% endif %}
        </ul>
      </div>

      <!-- AI Analysis Summary-->
      <div class="tk-card mt-4">
        <div class="fw-semibold mb-2">AI Analysis Summary</div>
        <div class="tk-subtle" style="white-space: pre-wrap;">
          {% if ai_summary %}{{ ai_summary }}{% else %}
            <em>AI analysis is not available for this scan.</em>
          {% endif %}
        </div>
      </div>

      <script>
        window.addEventListener('load', function () {
          const el = document.getElementById('email-results');
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            el.setAttribute('tabindex', '-1');
            el.focus({ preventScroll: true });
          }
        });
      </script>
    {% endif %}
  {% endif %}
</form>
{% endblock %}
