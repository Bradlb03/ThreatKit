# threatkit/malware/__init__.py
from flask import Blueprint, request, jsonify
from pathlib import Path
import joblib

from .feats import extract_features  

bp = Blueprint("malware", __name__)

BASE_DIR = Path(__file__).resolve().parent
MODELS_DIR = BASE_DIR / "models"

MODEL_PATH = MODELS_DIR / "baseline.pkl"
SCALER_PATH = MODELS_DIR / "scaler.pkl"

ML_MODEL = joblib.load(MODEL_PATH)
SCALER = joblib.load(SCALER_PATH)


def preprocess_file_bytes(file_bytes: bytes):
    X_raw, feats = extract_features(file_bytes)
    X_scaled = SCALER.transform(X_raw)
    return X_scaled, feats


def apply_rules(features: dict):
    rules = []
    entropy = features.get("byteentropy_true", 0.0)
    imports = features.get("import_count", 0)

    if entropy > 6.5:
        rules.append("High byte entropy (possible packing/encryption)")
    if imports > 500:
        rules.append("Unusually high number of imports")
    if imports == 0:
        rules.append("No imports detected (suspicious for executable)")

    return rules


@bp.post("/malware")
def api_malware():
    if "file" not in request.files:
        return jsonify({"error": "No file part in request"}), 400

    uploaded = request.files["file"]
    if uploaded.filename == "":
        return jsonify({"error": "No selected file"}), 400

    file_bytes = uploaded.read()
    if not file_bytes:
        return jsonify({"error": "Empty file"}), 400

    X_scaled, features = preprocess_file_bytes(file_bytes)
    proba = float(model.predict_proba(X_scaled)[0, 1])
    label = "malicious" if proba >= 0.5 else "benign"

    rules_triggered = apply_rules(features)

    return jsonify(
        {
            "features": features,
            "prediction": label,
            "score": proba,
            "rules_triggered": rules_triggered,
        }
    )
