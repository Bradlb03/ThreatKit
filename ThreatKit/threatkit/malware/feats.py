# threatkit/malware/feats.py

import math
from typing import Dict

try:
    import pefile
except ImportError:
    pefile = None  # handle non-PE / missing pefile gracefully

# Order of features expected by the model / scan_file
FEATURE_ORDER = ["byteentropy_true", "import_count"]


def _byte_entropy(data: bytes, num_bins: int = 256) -> float:
    """Compute Shannon entropy over raw bytes."""
    if not data:
        return 0.0

    counts = [0] * num_bins
    for b in data:
        counts[b] += 1

    total = len(data)
    ent = 0.0
    for c in counts:
        if c:
            p = c / total
            ent -= p * math.log2(p)
    return ent


def extract_features_from_bytes(data: bytes) -> Dict[str, float]:
    """
    Minimal feature extractor used by the API (from raw bytes).

    Returns a dict with keys matching FEATURE_ORDER:
      - byteentropy_true: entropy of the file bytes
      - import_count: number of PE import descriptors (0 for non-PE files)
    """
    features = {
        "byteentropy_true": _byte_entropy(data),
        "import_count": 0,
    }

    # Try to treat it as a PE file and count imports
    if pefile is not None:
        try:
            pe = pefile.PE(data=data, fast_load=True)
            pe.parse_data_directories(
                directories=[pefile.DIRECTORY_ENTRY["IMAGE_DIRECTORY_ENTRY_IMPORT"]]
            )
            if hasattr(pe, "DIRECTORY_ENTRY_IMPORT"):
                # number of import descriptors
                features["import_count"] = len(pe.DIRECTORY_ENTRY_IMPORT)
        except Exception:
            # Non-PE or parsing failed â€“ leave import_count at 0
            pass

    return features
