# Malware Detection – Overview

## Planned Pipeline (v1)
**dataset → preprocessing → ML model → explainability**

1) **Dataset**  
   - Source: EMBER 2018 (static, features-only).  
   - Files: `datasets/ember/ember2018/train_features_*.jsonl`, `test_features.jsonl`.

2) **Preprocessing**  
   - Parse JSONL → flatten nested `features` → tidy columns (e.g., `general.size`, `entropy_mean`, `imports.*`).  
   - Processed subsets to CSV for notebooks.

3) **ML Model**   
   - Targets: binary classification (`label`: 0=benign, 1=malicious).  
   - Metrics: accuracy, precision/recall, ROC-AUC; watch for class imbalance.

4) **Explainability**    
   - Deliverables: plots saved under `malware/docs/` and summarized in `malware/docs/exploration.md`.

---

## YARA Rules (Static Heuristics) – Why and How They Complement ML

We use a small set of **YARA rules** as transparent, human-readable heuristics that flag classic indicators while the ML model learns broader patterns.  
YARA = **if-this-then-flag** rules; ML = **learned scoring**. Together:

- **Strengths of YARA**: deterministic, explainable, great for triage and unit tests.  
- **Strengths of ML**: captures subtle, multi-feature patterns and generalizes beyond known strings.  
- **Combined workflow**:  
  1) Run YARA first for **fast triage** and to surface “obvious” hits.  
  2) Send all files (including YARA hits) through the **ML model** for a probability score.  
  3) Use **explainability** to justify ML decisions; use YARA hits as additional context in analyst reports.

### Current rule set (summary)
- **Packed executables (UPX / ASPack)**  
  Looks for packer markers like `UPX!`, `.UPX`, `ASPack`, `.aspack` plus simple PE hints (heuristic).
- **Suspicious Win32 API usage**  
  Flags presence of multiple process-injection/memory APIs: `CreateRemoteThread`, `VirtualAlloc`, `WriteProcessMemory`, `GetProcAddress`, `LoadLibraryA`.
- **Malware keywords / paths**  
  Flags strings like `hacktool`, suspicious user-profile locations (e.g., `AppData\Roaming`), temp paths, and common “keylogger” markers.

> Rules live in: `malware/rules/initial_rules.yar` (source) and `notebooks/malware/rules/initial_rules_test.yar` (test-friendly).  
> Example compiled form: `initial_rules_test.yarc` for faster scanning with `yara -C`.

---

## Future Work – Dynamic Analysis (Sandboxing)

Static features + YARA are safe and reproducible, but **dynamic behavior** strengthens detection and reduces false positives.

- Plan to integrate a sandbox (e.g., **Cuckoo**) in a later phase to capture:
  - Process tree, network activity, dropped files, registry changes, and API behavior.
  - Derived dynamic features to feed a hybrid ML model (static + dynamic).
- Safety: sandboxing will run in **isolated VMs/containers** with strict network controls and mentor approval.

---

## Repo Pointers

- **Notebooks**: `notebooks/Exploration.ipynb` (EDA, plots saved to `malware/docs/`).  
- **Docs**: `malware/docs/exploration.md` (short write-up + figure references).  
- **Rules**: `malware/rules/` (YARA rules, test artifacts).  
- **Data**: `datasets/ember/ember2018/` (JSONL); sampled CSVs for speed.