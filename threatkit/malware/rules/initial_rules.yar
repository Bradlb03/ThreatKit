import "pe"

/*
  Packed executables (UPX / ASPack)
  Heuristic: look for common packer section names/strings.
*/
rule Packed_UPX_or_ASPack
{
  meta:
    author = "Eric"
    purpose = "Detect common packer markers in PE files (heuristic)"
    note = "Packed != malicious; use as a triage signal"

  strings:
    // UPX markers
    $upx0 = ".UPX0" ascii nocase
    $upx1 = ".UPX1" ascii nocase
    $upx  = "UPX" ascii nocase

    // ASPack markers
    $aspack_str = "ASPack" ascii nocase
    $aspack_sec = ".aspack" ascii nocase

  condition:
    pe.number_of_sections > 0 and
    filesize < 10MB and
    ( 2 of ($upx*) or 1 of ($aspack*) or
      pe.section_index(".UPX0") != -1 or
      pe.section_index(".UPX1") != -1 )
}

/*
  Suspicious API calls
  Heuristic: presence of multiple process-injection / memory-tampering APIs.
*/
rule Suspicious_Win32_APIs
{
  meta:
    author = "Eric"
    purpose = "Flag binaries importing multiple injection-related APIs"
    note = "Require >=2 hits to reduce FPs"

  strings:
    $api1 = "CreateRemoteThread" ascii wide nocase
    $api2 = "WriteProcessMemory" ascii wide nocase
    $api3 = "VirtualAlloc" ascii wide nocase
    $api4 = "VirtualProtect" ascii wide nocase
    $api5 = "OpenProcess" ascii wide nocase
    $api6 = "NtUnmapViewOfSection" ascii wide nocase
    $api7 = "AllocConsole" ascii wide nocase
    $api8 = "AdjustTokenPrivileges" ascii wide nocase

  condition:
    pe.number_of_sections > 0 and
    filesize < 20MB and
    (
      // EITHER the literal API names are present…
      2 of ($api*)
      // …OR imports table shows them (if import table isn’t stripped)
      or
      pe.imports("KERNEL32.dll", "CreateRemoteThread") or
      pe.imports("KERNEL32.dll", "WriteProcessMemory") or
      pe.imports("KERNEL32.dll", "OpenProcess") or
      pe.imports("KERNEL32.dll", "VirtualAlloc") or
      pe.imports("KERNEL32.dll", "VirtualProtect") or
      pe.imports("NTDLL.dll",   "NtUnmapViewOfSection")
    )
}

/*
  Common malware strings / paths
  Heuristic: keywords + suspicious install locations. Require 2+ hits.
*/
rule Common_Malware_Keywords_and_Paths
{
  meta:
    author = "Eric"
    purpose = "Flag obvious ‘hacktool’ keywords and shady persistence paths"
    note = "Designed as a coarse filter"

  strings:
    // Keywords
    $kw1 = "hacktool" ascii wide nocase
    $kw2 = "keylogger" ascii wide nocase
    $kw3 = "stealer" ascii wide nocase
    $kw4 = "ransomware" ascii wide nocase
    $kw5 = "botnet" ascii wide nocase
    $kw6 = "mimikatz" ascii wide nocase

    // Suspicious Windows paths / persistence clues
    $p1 = "\\AppData\\Roaming\\" ascii wide nocase
    $p2 = "C:\\Users\\Public\\" ascii wide nocase
    $p3 = "\\Temp\\" ascii wide nocase
    $p4 = "\\Startup" ascii wide nocase
    $p5 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
    $p6 = "schtasks /create" ascii wide nocase
    $p7 = "powershell -enc" ascii wide nocase

  condition:
    filesize < 50MB and
    ( 2 of ($kw*, $p*) )
}
